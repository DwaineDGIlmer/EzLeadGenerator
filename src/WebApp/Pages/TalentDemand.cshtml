@page
@model TalentDemandModel
@using WebApp.Pages
@inject Microsoft.AspNetCore.Mvc.ViewFeatures.ModelExpressionProvider ModelExpressionProvider
@{
    ViewData["Title"] = "Talent Demand Insights";
}
<!-- Foundational style sheet -->
<link rel="stylesheet" href="~/css/ezleadgenerator.styles.css" />

@if (Model.QueryTooShort)
{
    <div class="alert alert-warning" role="alert">
        Please enter at least 4 characters for your search query.
    </div>
}

<h2 class="mb-4">Talent Demand Insights</h2>
<div class="alert alert-info mb-3">
    <h5>How to Use Talent Demand Insights</h5>
    <ul>
        <li><strong>Search for Roles:</strong> Enter a job title or keyword (e.g., "AI Engineer"). For best results, use at least 4 characters.</li>
        <li><strong>Search as exact phrase:</strong> If checked, the search will look for the exact phrase; otherwise, it will match any of the words.</li>
        <li><strong>Location:</strong> Enter a city, state, or "Remote" to filter results.</li>
        <li><strong>Include job descriptions:</strong> Check to display job descriptions in the results.</li>
        <li><strong>Results:</strong> Jobs are grouped by company and can be downloaded as a CSV file.</li>
    </ul>
    <strong>Tip:</strong> Enter a job title and location to find relevant jobs. For more precise results, check "Search as exact phrase" to match the exact job title and location together.
</div>
<div class="card">
    <form method="post">
        <div class="mb-3">
            <label class="form-label">Search for Roles:</label>
            <input asp-for="JobTitle" class="form-control" placeholder="e.g. Data Engineer" style="max-width: 500px;" />
            <div class="form-check form-check-inline">
                <input type="checkbox" asp-for="SearchJobTitleAsPhrase" class="form-check-input" />
                <label asp-for="SearchJobTitleAsPhrase" class="form-check-label">Search as exact phrase</label>
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label">Location (City, State or 'Remote'):</label>
            <input asp-for="Location" class="form-control" placeholder="e.g. Remote, San Francisco" style="max-width: 500px;" />
            <div class="form-check form-check-inline">
                <input type="checkbox" asp-for="IncludeDescriptions" class="form-check-input" />
                <label asp-for="IncludeDescriptions" class="form-check-label">Include job descriptions</label>
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label">Include these words in the search, separate each with a comma:</label>
            <input asp-for="Inclusions" class="form-control" placeholder="e.g. Microsoft, Cloud" style="max-width: 500px;" />
        </div>
        <button type="submit" class="btn btn-primary">Search</button>
    </form>
</div>

@if (Model.GroupedJobResults.Any())
{
    <div class="note-box mb-3">
        📁 <strong>Note:</strong> Your CSV file will download through your browser. Check your <em>Downloads</em> folder.
    </div>

    <div class="card">
        <form method="post" asp-page-handler="Download" class="mb-3">
            @Html.AntiForgeryToken()
            <input type="hidden" name="JobTitle" value="@Model.JobTitle" />
            <input type="hidden" name="Location" value="@Model.Location" />
            <input type="hidden" name="ResultsCacheKey" value="@Model.ResultsCacheKey" />
            <input type="hidden" name="IncludeDescriptions" value="@Model.IncludeDescriptions" />
            <button type="submit" class="btn btn-success">Download Results as CSV</button>
        </form>
        <h2 class="mb-4">Open Positions Grouped by Company</h2>

        @foreach (var companyGroup in Model.GroupedJobResults)
        {
            <h3 class="mt-4 mb-2 border-bottom pb-2">@companyGroup.Key</h3>
            <table>
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Location</th>
                        <th>Type</th>
                        <th>Posted</th>
                        <th>Posting</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var job in companyGroup.Value)
                    {
                        <tr>
                            <td>@job.Title</td>
                            <td>@job.Location</td>
                            <td>@job.Type</td>
                            <td>@job.Posted</td>
                            <td>
                                @if (!string.IsNullOrWhiteSpace(job.ApplyLink))
                                {
                                    <a href="@job.ApplyLink" target="_blank">Link</a>
                                }
                                else
                                {
                                    <span>N/A</span>
                                }
                            </td>
                        </tr>
                        @if (Model.IncludeDescriptions && !string.IsNullOrWhiteSpace(job.Description))
                        {
                            <tr>
                                <td colspan="5" style="background-color: #f9f9f9;">
                                    <strong>Description:</strong><br />
                                    <div style="white-space: pre-wrap;">@job.Description</div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        }
    </div>
}